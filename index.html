<html>

<head>
  <title>New Zealand Cancer Map</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.css"
    integrity="sha256-iYUgmrapfDGvBrePJPrMWQZDcObdAcStKBpjP3Az+3s=" crossorigin="anonymous" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.js"
    integrity="sha256-CNm+7c26DTTCGRQkM9vp7aP85kHFMqs9MhPEuytF+fQ=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/leaflet-providers@1.3.0/leaflet-providers.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  <script src="https://eknowles.github.io/resizerjs/resizer.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.0.3/chroma.min.js"></script>
  <link rel="stylesheet" href="style.css" />

</head>

<body>
  <h1 id="title">New Zealand Cancer Map</h1>
  <div id="mainrow" class="row">
    <div id="map"></div>
    <div id="plots">
      <div id="controls">
        <input type="checkbox" id="per" />
        <label for="per">Display cancer/smoking values as per 100K people</label><br>
      </div>
      <div class="row">
        <div id="cancertypes" style="width:50%"></div>
        <div id="smoking" style="width:50%"></div>
      </div>
      <div id="age"></div>
      <div id="pcp"></div>
      <div style="text-align: center;">
        <label for="cancertype">Parallel coordinate plot options:</label>
        <select id="cancertype">
          <option value="breast">Breast cancer</option>
          <option value="prostate">Prostate cancer</option>
          <option value="lung" selected>Lung cancer</option>
        </select>
        <select id="eth">
          <option value="maori" selected>Māori</option>
          <option value="non-maori">Non-māori</option>
        </select>
      </div>
      <div id="imd"></div>
    </div>
  </div>
  <script>
    const myResizer = new Resizer('.row');
    var map = L.map('map', {
      zoom: 6,
      minZoom: 6,
      maxZoom: 14,
      center: [-41.235726, 172.5118422]
    });
    var bounds = map.getBounds();
    bounds._northEast.lat += 10;
    bounds._northEast.lng += 10;
    bounds._southWest.lat -= 10;
    bounds._southWest.lng -= 10;
    map.setMaxBounds(bounds);

    var baseMaps = {
      "OSM": L.tileLayer.provider("OpenStreetMap.Mapnik"),
      "OSM Grayscale": L.tileLayer.provider("OpenStreetMap.BlackAndWhite"),
      "CartoDB Positron": L.tileLayer.provider('CartoDB.PositronNoLabels').addTo(map),
      "CartoDB Dark Matter": L.tileLayer.provider("CartoDB.DarkMatter"),
      "ESRI WorldImagery": L.tileLayer.provider("Esri.WorldImagery"),
      "Google Hybrid": L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
        maxZoom: 20,
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
      }),
      "Wikimedia": L.tileLayer.provider("Wikimedia")
    }

    map.createPane('labels');
    map.getPane('labels').style.zIndex = 625;
    map.getPane('labels').style.pointerEvents = 'none';
    var labels = L.tileLayer.provider("Stamen.TonerLabels", {
      pane: "labels",
      interactive: false,
      opacity: .8,
    });

    map.createPane('whitelabels');
    map.getPane('whitelabels').style.zIndex = 625;
    map.getPane('whitelabels').style.pointerEvents = 'none';
    map.getPane('whitelabels').style.filter = 'invert(100%)';
    var whitelabels = L.tileLayer.provider("Stamen.TonerLabels", {
      pane: "whitelabels",
      interactive: false,
      opacity: .8,
    });

    var overlayMaps = {
      "City labels": labels,
      "City labels (white)": whitelabels,
    }

    L.control.layers(baseMaps, overlayMaps).addTo(map);

    const MIN_DOMAIN = 1;
    const MAX_DOMAIN = 3;
    const RATE_PER = 1E5;
    var cmap = chroma.scale("BuGn").domain([MIN_DOMAIN, MAX_DOMAIN]);

    $("#per, #cancertype, #eth").change(function (e) {
      updatePlots(c, s, age_summary, "NZ")
      createPCP($("#cancertype").val(), $("#eth").val());
    });

    function createPCP(ct, eth) {
      console.log(ct, eth);
      var dimensions = []
      if (eth == "maori") {
        var pcpColumns = {
          'Māori 2010-2012': "maori2010-2012",
          'Māori 2013-2015': "maori2013-2015",
          'Māori 2016-2018': "maori2016-2018",
        }  
      } else {
        var pcpColumns = {
          'Non-māori 2010-2012': "non-maori2010-2012",
          'Non-māori 2013-2015': "non-maori2013-2015",
          'Non-māori 2016-2018': "non-maori2016-2018",
        }
      }
      for (var k in pcpColumns) {
        if ($("#per").is(":checked")) {
          var values = []
          for (var f of geojson.features) {
            if (k.startsWith("Māori")) {
              var denominator = f.properties.age.Maori.Total
            } else {
              var denominator = f.properties.age["Non-maori"].Total
            }
            values.push(f.properties.cancer[ct + pcpColumns[k]] / denominator * RATE_PER)
          }
        } else {
          var values = geojson.features.map(f => f.properties.cancer[ct + pcpColumns[k]])
        }
        dimensions.push({
          label: k,
          values: values
        })
      }
      console.log(dimensions)
      var pcpPlotData = [{
        type: 'parcoords',
        line: {
          color: Object.keys(geojson.features),
          colorscale: 'Jet'
        },

        dimensions: dimensions
      }];

      layout = {
        title: "Parallel coordinate plot of " + ct + " cancer distribution in NZ",
        //height: 300
      }

      Plotly.newPlot('pcp', pcpPlotData, layout, { responsive: true });
    }

    function updatePlots(c, s, age_summary, region) {
      var c = { ...c };
      var s = { ...s };
      var imdY = [
        geojson.features.map(f => f.properties.cancer["total 18+ all cancertotal2016-2018"]),
        geojson.features.map(f => f.properties.cancer["breasttotal2016-2018"]),
        geojson.features.map(f => f.properties.cancer["prostatetotal2016-2018"]),
        geojson.features.map(f => f.properties.cancer["lungtotal2016-2018"]),
      ]
      if ($("#per").is(":checked")) {
        var total_maori = age_summary.Maori.Total;
        var total_nonmaori = age_summary["Non-maori"].Total;
        for (var k in c) {
          if (!k.includes("non-maori")) {
            c[k] = c[k] / total_maori * RATE_PER
          } else {
            c[k] = c[k] / total_nonmaori * RATE_PER
          }
        }
        for (var k in s) {
          if (k.startsWith("maori")) {
            s[k] = s[k] / total_maori * RATE_PER
          } else {
            s[k] = s[k] / total_nonmaori * RATE_PER
          }
        }
        imdY = [
          geojsonPer100K.features.map(f => f.properties.cancer["total 18+ all cancertotal2016-2018"]),
          geojsonPer100K.features.map(f => f.properties.cancer["breasttotal2016-2018"]),
          geojsonPer100K.features.map(f => f.properties.cancer["prostatetotal2016-2018"]),
          geojsonPer100K.features.map(f => f.properties.cancer["lungtotal2016-2018"]),
        ]
      }
      console.log(imdY)
      Plotly.update(cancertypes,
        {
          y: [
            [c["breastmaori2016-2018"], c["prostatemaori2016-2018"], c["lungmaori2016-2018"]],
            [c["breastnon-maori2016-2018"], c["prostatenon-maori2016-2018"], c["lungnon-maori2016-2018"]]
          ],
        },
        {
          title: "Cancer types in " + region + " from 2016-2018",
        }
      );
      Plotly.update(smoking,
        {
          y: [
            [s["maori_male_smoker"], s["maori_male_non-smoker"], s["maori_female_smoker"], s["maori_female_non-smoker"]],
            [s["non-maori_male_smoker"], s["non-maori_male_non-smoker"], s["non-maori_female_smoker"], s["non-maori_female_non-smoker"]]
          ],
        },
        {
          title: "Smoking in " + region + " as per the 2018 census",
        }
      );
      Plotly.update(age,
        {
          y: [
            ageKeys.map(k => age_summary["Maori"][k]),
            ageKeys.map(k => age_summary["Non-maori"][k])
          ],
        },
        {
          title: "Age distribution in " + region + " as per the 2018 census",
        }
      );
      var pcpDataUpdate = {
        line: {
          color: Object.keys(geojson.features),
          colorscale: 'Jet'
        }
      }
      if (region != "NZ") {
        pcpDataUpdate = {
          line: {
            color: Object.keys(geojson.features).map(k => geojson.features[k].properties.TALB2018_1 == region ? 1 : 0),
            colorscale: [[0, 'gray'], [1, 'red']]
          }
        }
      }
      Plotly.restyle(pcp, pcpDataUpdate);

      Plotly.restyle(imd,
        {
          y: imdY,
        }
      );
    }

    $.getJSON("data/TALB_2018.geojson", function (geojson) {
      console.log(geojson);
      window.geojson = geojson;
      // precalculate rates per 100K for each TALB
      var geojsonPer100K = JSON.parse(JSON.stringify(geojson))
      for (var f of geojsonPer100K.features) {
        for (var k in f.properties.cancer) {
          if (k.includes("total")) {
            f.properties.cancer[k] = f.properties.cancer[k] / f.properties.age.Total.Total * RATE_PER
          } else if (k.includes("non-maori")) {
            f.properties.cancer[k] = f.properties.cancer[k] / f.properties.age["Non-maori"].Total * RATE_PER
          } else {
            f.properties.cancer[k] = f.properties.cancer[k] / f.properties.age["Maori"].Total * RATE_PER
          }
        }
      }
      window.geojsonPer100K = geojsonPer100K;
      console.log(geojsonPer100K)
      var geojsonLayer = new L.GeoJSON(geojson, {
        style: function (feature) {
          var cancer = feature.properties.cancer["total 18+ all cancertotal2016-2018"];
          cancer = cancer / feature.properties.smoking["total_15+"] * 100
          feature.cancer = cancer;
          //console.log(feature, cancer);
          return {
            fillColor: cmap(cancer),
            fillOpacity: .7,
            color: "black",
            //dashArray: "2,2",
            weight: .5
          }
        },
        onEachFeature: function (feature, layer) {
          layer.bindTooltip(feature.properties.TALB2018_1 + " " + feature.cancer.toLocaleString() + "%")
          layer.on('mouseover', function (event) {
            updatePlots(feature.properties.cancer, feature.properties.smoking, feature.properties.age, feature.properties.TALB2018_1)
          }).on("mouseout", function () {
            updatePlots(window.c, window.s, window.age_summary, "NZ")
          });
        },
        filter: function (feature, layer) {
          return feature.properties.cancer;
        },
      }).addTo(map);
      window.c = {}
      window.s = {}
      window.age_summary = {
        "Maori": {},
        "Non-maori": {}
      }
      window.ageKeys = ["0-4 years", "5-9 years", "10-14 years", "15-19 years", "20-24 years", "25-29 years", "30-34 years", "35-39 years", "40-44 years", "45-49 years", "50-54 years", "55-59 years", "60-64 years", "65-69 years", "70-74 years", "75-79 years", "80-84 years", "85 years and over"];
      for (var f of geojson.features) {
        for (var k in f.properties.cancer) {
          if (!c[k]) c[k] = 0;
          if (f.properties.cancer[k] != "S") {
            c[k] += f.properties.cancer[k];
          }
        }
        for (var k in f.properties.smoking) {
          if (!s[k]) s[k] = 0;
          s[k] += f.properties.smoking[k];
        }
        for (var k in f.properties.age.Maori) {
          if (!age_summary.Maori[k]) age_summary.Maori[k] = 0;
          if (!age_summary["Non-maori"][k]) age_summary["Non-maori"][k] = 0;
          if (f.properties.age.Maori[k]) age_summary.Maori[k] += f.properties.age.Maori[k];
          if (f.properties.age["Non-maori"][k]) age_summary["Non-maori"][k] += f.properties.age["Non-maori"][k];
        }
      }
      console.log(c, s, age_summary)
      var cancerPlotData = [{
        name: "Māori",
        x: ["Breast cancer", "Prostate cancer", "Lung cancer"],
        y: [c["breastmaori2016-2018"], c["prostatemaori2016-2018"], c["lungmaori2016-2018"]],
        type: 'bar',
      },
      {
        name: "Non-māori",
        x: ["Breast cancer", "Prostate cancer", "Lung cancer"],
        y: [c["breastnon-maori2016-2018"], c["prostatenon-maori2016-2018"], c["lungnon-maori2016-2018"]],
        type: 'bar',
      }];
      layout = {
        title: "Cancer types in NZ from 2016-2018",
        //showlegend: false,
        barmode: 'stack',
        textinfo: "label+value",
        textposition: "outside",
        height: 300,
      }
      Plotly.newPlot("cancertypes", cancerPlotData, layout, { responsive: true });

      var smokingPlotData = [{
        name: "Māori",
        x: ["Male smoker", "Male non-smoker", "Female smoker", "Female non-smoker"],
        y: [s["maori_male_smoker"], s["maori_male_non-smoker"], s["maori_female_smoker"], s["maori_female_non-smoker"]],
        type: 'bar',
      },
      {
        name: "Non-māori",
        x: ["Male smoker", "Male non-smoker", "Female smoker", "Female non-smoker"],
        y: [s["non-maori_male_smoker"], s["non-maori_male_non-smoker"], s["non-maori_female_smoker"], s["non-maori_female_non-smoker"]],
        type: 'bar',
      }];
      layout = {
        title: "Smoking in NZ as per the 2018 census",
        //showlegend: false,
        barmode: 'stack',
        textinfo: "label+value",
        textposition: "outside",
        height: 300,
      }
      Plotly.newPlot("smoking", smokingPlotData, layout, { responsive: true });

      var agePlotData = [{
        name: "Māori",
        x: ageKeys,
        y: ageKeys.map(k => age_summary.Maori[k]),
        type: 'bar',
      },
      {
        name: "Non-māori",
        x: ageKeys,
        y: ageKeys.map(k => age_summary["Non-maori"][k]),
        type: 'bar',
      }];
      layout = {
        title: "Age distribution in NZ as per the 2018 census",
        //showlegend: false,
        barmode: 'stack',
        textinfo: "label+value",
        textposition: "outside",
        height: 300,
      }
      Plotly.newPlot("age", agePlotData, layout, { responsive: true });
      createPCP("lung");

      var depPlotData = [
        {
          x: geojson.features.map(f => f.properties.IMD18_mean),
          y: geojson.features.map(f => f.properties.cancer["total 18+ all cancertotal2016-2018"]),
          text: geojson.features.map(f => f.properties.TALB2018_1),
          name: "All cancer",
          mode: 'markers',
          type: 'scatter'
        },
        {
          x: geojson.features.map(f => f.properties.IMD18_mean),
          y: geojson.features.map(f => f.properties.cancer["breasttotal2016-2018"]),
          text: geojson.features.map(f => f.properties.TALB2018_1),
          name: "Breast cancer",
          mode: 'markers',
          type: 'scatter'
        },
        {
          x: geojson.features.map(f => f.properties.IMD18_mean),
          y: geojson.features.map(f => f.properties.cancer["prostatetotal2016-2018"]),
          text: geojson.features.map(f => f.properties.TALB2018_1),
          name: "Prostate cancer",
          mode: 'markers',
          type: 'scatter'
        },
        {
          x: geojson.features.map(f => f.properties.IMD18_mean),
          y: geojson.features.map(f => f.properties.cancer["lungtotal2016-2018"]),
          text: geojson.features.map(f => f.properties.TALB2018_1),
          name: "Lung cancer",
          mode: 'markers',
          type: 'scatter'
        }
      ]
      console.log(depPlotData)
      layout = {
        title: "IMD2018 deprivation vs cancer distribution in NZ",
        xaxis: {
          title: "Mean IMD2018 deprivation rank"
        },
        yaxis: {
          title: "# of cancer cases"
        },
        //showlegend: false,
        height: 600,
      }
      Plotly.newPlot("imd", depPlotData, layout, { responsive: true });
    });

    var legend = L.control({ position: 'bottomright' });

    legend.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'info legend');
      var cancerLegend = "<div id='cancerLegend'><h4>Cancer registrations from 2016-2018 divided by 2018 adult population (percentage)</h4>";
      for (var i = MIN_DOMAIN; i <= MAX_DOMAIN; i += .5) {
        var i_text = i.toLocaleString();
        if (i == MIN_DOMAIN) i_text = "<=" + i
        if (i == MAX_DOMAIN) i_text = ">=" + i
        cancerLegend += '<i style="background:' + cmap(i) + '"></i> ' + i_text + '<br>';
      }
      div.innerHTML += cancerLegend + "</div><div>Hover over an area to show plots for that area</div>";
      return div;
    };

    legend.addTo(map);

  </script>
</body>

</html>