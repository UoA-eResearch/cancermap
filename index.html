<html>

<head>
  <title>New Zealand Cancer Map</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.css"
    integrity="sha256-iYUgmrapfDGvBrePJPrMWQZDcObdAcStKBpjP3Az+3s=" crossorigin="anonymous" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.js"
    integrity="sha256-CNm+7c26DTTCGRQkM9vp7aP85kHFMqs9MhPEuytF+fQ=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/leaflet-providers@1.3.0/leaflet-providers.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.0.3/chroma.min.js"></script>
  <link rel="stylesheet" href="style.css" />

</head>

<body>
  <h1 id="title">New Zealand Cancer Map</h1>
  <div class="row" style="height: 100%">
    <div id="map"></div>
    <div id="plots">
      <div id="cancertypes"></div>
      <div id="smoking"></div>
    </div>
  </div>
  <script>
    var map = L.map('map', {
      zoom: 6,
      minZoom: 6,
      maxZoom: 14,
      center: [-41.235726, 172.5118422]
    });
    var bounds = map.getBounds();
    bounds._northEast.lat += 10;
    bounds._northEast.lng += 10;
    bounds._southWest.lat -= 10;
    bounds._southWest.lng -= 10;
    map.setMaxBounds(bounds);

    var baseMaps = {
      "OSM": L.tileLayer.provider("OpenStreetMap.Mapnik"),
      "OSM Grayscale": L.tileLayer.provider("OpenStreetMap.BlackAndWhite"),
      "CartoDB Positron": L.tileLayer.provider('CartoDB.PositronNoLabels').addTo(map),
      "CartoDB Dark Matter": L.tileLayer.provider("CartoDB.DarkMatter"),
      "ESRI WorldImagery": L.tileLayer.provider("Esri.WorldImagery"),
      "Google Hybrid": L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
        maxZoom: 20,
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
      }),
      "Wikimedia": L.tileLayer.provider("Wikimedia")
    }

    map.createPane('labels');
    map.getPane('labels').style.zIndex = 625;
    map.getPane('labels').style.pointerEvents = 'none';
    var labels = L.tileLayer.provider("Stamen.TonerLabels", {
        pane: "labels",
        interactive: false,
        opacity: .8,
    });

    map.createPane('whitelabels');
    map.getPane('whitelabels').style.zIndex = 625;
    map.getPane('whitelabels').style.pointerEvents = 'none';
    map.getPane('whitelabels').style.filter = 'invert(100%)';
    var whitelabels = L.tileLayer.provider("Stamen.TonerLabels", {
        pane: "whitelabels",
        interactive: false,
        opacity: .8,
    });

    var overlayMaps = {
      "City labels": labels,
      "City labels (white)": whitelabels,
    }

    L.control.layers(baseMaps, overlayMaps).addTo(map);

    var MIN_DOMAIN = 5;
    var MAX_DOMAIN = 9;
    var cmap = chroma.scale("Spectral").domain([MAX_DOMAIN, MIN_DOMAIN]);

    $.getJSON("data/TALB_2018.geojson", function (geojson) {
      console.log(geojson);
      var geojsonLayer = new L.GeoJSON(geojson, {
        style: function(feature) {
          var cancer = feature.properties.cancer["maori_all_cancer_18+"] + feature.properties.cancer["non-maori_all_cancer_18+"];
          cancer = cancer / feature.properties.smoking["total_15+"] * 100
          feature.cancer = cancer;
          console.log(feature, cancer);
          return {
            fillColor: cmap(cancer),
            fillOpacity: .7,
            color: "black",
            //dashArray: "2,2",
            weight: .5
          }
        },
        onEachFeature: function (feature, layer) {
          layer.bindTooltip(feature.properties.TALB2018_1 + " " + feature.cancer.toLocaleString() + "%")
          layer.on('mouseover',function(event) {
            var c = feature.properties.cancer;
            Plotly.update(cancertypes,
              {
                values: [[c.maori_breast_cancer, c.maori_prostate_cancer, c.maori_lung_cancer, c["non-maori_breast_cancer"], c["non-maori_prostate_cancer"], c["non-maori_lung_cancer"]]],
              },
              {
                title: "Cancer types in " + feature.properties.TALB2018_1,
              }
            );
            Plotly.update(smoking,
              {
                values: [s_keys.map(k => feature.properties.smoking[k])],
              },
              {
                title: "Smoking in " + feature.properties.TALB2018_1,
              }
            );
          }).on("mouseout", function() {
            Plotly.update(cancertypes,
              {
                values: [window.nz_cancer_values],
              },
              {
                title: "Cancer types in NZ",
              }
            );
            Plotly.update(smoking,
              {
                values: [window.nz_smoking],
              },
              {
                title: "Smoking in NZ",
              }
            );
          });
        },
        filter: function(feature, layer) {
          return feature.properties.cancer;
        },
      }).addTo(map);
      var c = {}
      var s = {}
      for (var f of geojson.features) {
        for (var k in f.properties.cancer) {
          if (!c[k]) c[k] = 0;
          if (f.properties.cancer[k] != "S") {
            c[k] += f.properties.cancer[k];
          }
        }
        for (var k in f.properties.smoking) {
          if (!s[k]) s[k] = 0;
          s[k] += f.properties.smoking[k];
        }
      }
      console.log(c, s)
      window.nz_cancer_values = [c.maori_breast_cancer, c.maori_prostate_cancer, c.maori_lung_cancer, c["non-maori_breast_cancer"], c["non-maori_prostate_cancer"], c["non-maori_lung_cancer"]]
      var cancerPlotData = [{
          labels: ["Māori breast cancer", "Māori prostate cancer", "Māori lung cancer", "Non-māori breast cancer", "Non-māori prostate cancer", "Non-māori lung cancer"],
          values: nz_cancer_values,
          type: 'pie',
          textinfo: "label+value",
          textposition: "outside",
      }];
      layout = {
        title: "Cancer types in NZ",
        showlegend: false,
      }
      Plotly.newPlot("cancertypes", cancerPlotData, layout);

      window.s_keys = Object.keys(s).filter(k => k != "total_15+")

      String.prototype.capitalize = function() {
        return this.charAt(0).toUpperCase() + this.slice(1)
      }

      window.nz_smoking = s_keys.map(k => s[k])

      var smokingPlotData = [{
          labels: s_keys.map(k => k.replace(/_/g, " ").replace("maori", "māori").capitalize()),
          values: nz_smoking,
          type: 'pie',
          textinfo: "label+value",
          textposition: "outside",
      }];
      layout = {
        title: "Smoking in NZ",
        showlegend: false,
      }
      Plotly.newPlot("smoking", smokingPlotData, layout);
    });

    var legend = L.control({position: 'bottomright'});

    legend.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'info legend');
      var cancerLegend = "<div id='cancerLegend'><h4>Cancer registrations from 2008-2018 divided by 2018 adult population (percentage)</h4>";
      for (var i = MIN_DOMAIN; i <= MAX_DOMAIN; i += 1) {
        var i_text = i.toLocaleString();
        if (i == MIN_DOMAIN) i_text = "<=" + i
        if (i == MAX_DOMAIN) i_text = ">=" + i
        cancerLegend += '<i style="background:' + cmap(i) + '"></i> ' + i_text + '<br>';
      }
      div.innerHTML += cancerLegend + "</div>";
      return div;
    };

    legend.addTo(map);

  </script>
</body>

</html>